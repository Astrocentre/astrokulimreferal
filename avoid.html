<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avoid The Bomb</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    html, body {
      margin: 0; padding: 0; overflow: hidden; height: 100%; background: black;
      touch-action: none; user-select: none;
    }
    canvas {
      display: block;
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: radial-gradient(ellipse at center, #000000 0%, #0a0a1a 80%);
    }
    #score {
      position: fixed;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      color: #00f9ff;
      font-family: monospace;
      font-weight: 700;
      font-size: 24px;
      text-shadow: 0 0 8px #00f9ff;
      pointer-events: none;
      user-select: none;
      z-index: 10;
    }
  </style>
</head>
<body>
<canvas id="game"></canvas>
<div id="score">Score: 0</div>

<script>
  const supabase = supabase.createClient(
    'https://vpzclfvfmskozxeccvnn.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZwemNsZnZmbXNrb3p4ZWNjdm5uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMyNTUzNzUsImV4cCI6MjA2ODgzMTM3NX0.cr_PR99k9Ad-_RrtqcVF9oMaTDaBZw5fh46uwYHxVS8'
  );

  let userId = null;

  supabase.auth.getUser().then(({ data: { user } }) => {
    if (!user) {
      window.location.href = 'login.html';
    } else {
      userId = user.id;
    }
  });

  (() => {
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');

    let w, h;

    const player = {
      width: 60,
      height: 60,
      x: 0,
      y: 0,
      speed: 15
    };

    function resize() {
      w = canvas.width = window.innerWidth;
      h = canvas.height = window.innerHeight;
      player.x = w / 2 - player.width / 2;
      player.y = h - player.height - 60;
    }

    resize();
    window.addEventListener('resize', resize);

    const stars = Array.from({ length: 150 }, () => ({
      x: Math.random() * w,
      y: Math.random() * h,
      size: Math.random() * 1.5,
      speed: 0.5 + Math.random() * 1.5
    }));

    let bombs = [];
    let score = 0;
    let gameOver = false;

    function spawnBomb() {
      bombs.push({
        x: Math.random() * (w - 40),
        y: -50,
        size: 40,
        speed: 2 + Math.random() * 3
      });
    }

    async function submitScore(finalScore) {
      if (!userId) return;

      const { error } = await supabase.from('scores').insert([{
        user_id: userId,
        game: 'avoid',
        score: finalScore
      }]);

      if (error) {
        console.error('Failed to save score:', error);
      }
    }

    function update() {
      stars.forEach(s => {
        s.y += s.speed;
        if (s.y > h) s.y = 0;
      });

      bombs.forEach(bomb => bomb.y += bomb.speed);
      bombs = bombs.filter(b => b.y < h + bomb.size);

      bombs.forEach(bomb => {
        if (
          bomb.x < player.x + player.width &&
          bomb.x + bomb.size > player.x &&
          bomb.y < player.y + player.height &&
          bomb.y + bomb.size > player.y
        ) {
          gameOver = true;
          submitScore(score); // Save to Supabase
        }
      });

      if (!gameOver) score++;
    }

    function draw() {
      ctx.clearRect(0, 0, w, h);

      ctx.fillStyle = 'white';
      stars.forEach(s => {
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
        ctx.fill();
      });

      ctx.fillStyle = '#00f9ff';
      ctx.fillRect(player.x, player.y, player.width, player.height);

      bombs.forEach(bomb => {
        ctx.fillStyle = 'red';
        ctx.beginPath();
        ctx.arc(bomb.x + bomb.size / 2, bomb.y + bomb.size / 2, bomb.size / 2, 0, Math.PI * 2);
        ctx.fill();
      });

      document.getElementById('score').textContent = 'Score: ' + score;

      if (gameOver) {
        ctx.fillStyle = '#00f9ff';
        ctx.font = 'bold 60px monospace';
        ctx.textAlign = 'center';
        ctx.fillText('GAME OVER', w / 2, h / 2 - 20);
        ctx.font = '30px monospace';
        ctx.fillText('Final Score: ' + score, w / 2, h / 2 + 40);
      }
    }

    function gameLoop() {
      if (!gameOver) update();
      draw();
      if (!gameOver) requestAnimationFrame(gameLoop);
    }

    let touchX = null;
    canvas.addEventListener('touchstart', e => {
      if (e.touches.length === 1) touchX = e.touches[0].clientX;
    }, { passive: true });

    canvas.addEventListener('touchmove', e => {
      e.preventDefault();
      if (e.touches.length === 1) {
        let newX = e.touches[0].clientX;
        let delta = newX - touchX;
        player.x += delta;
        player.x = Math.min(Math.max(player.x, 0), w - player.width);
        touchX = newX;
      }
    }, { passive: false });

    canvas.addEventListener('touchend', () => touchX = null);

    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowLeft') player.x = Math.max(player.x - player.speed, 0);
      else if (e.key === 'ArrowRight') player.x = Math.min(player.x + player.speed, w - player.width);
    });

    setInterval(() => {
      if (!gameOver) spawnBomb();
    }, 800);

    gameLoop();
  })();
</script>
</body>
</html>
